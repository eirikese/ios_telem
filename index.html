<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>M5 IMU+GPS Publisher (iPhone native roll/pitch)</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <meta name="theme-color" content="#0b0b0f" />
  <style>
    :root { --bg:#0b0b0f; --fg:#e6e6e9; --muted:#9aa0a6; --accent:#61dafb; --bad:#ff6b6b; --ok:#30d158 }
    *{box-sizing:border-box} html,body{height:100%}
    body{margin:0;background:var(--bg);color:var(--fg);font:16px/1.4 system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial}
    header{padding:16px 20px;border-bottom:1px solid #222;display:flex;justify-content:space-between;align-items:center}
    header h1{margin:0;font-size:16px;color:var(--muted);font-weight:600}
    header .ver{font-size:12px;color:var(--muted)}
    main{padding:16px 16px 76px}
    .card{background:#121218;border:1px solid #222;border-radius:12px;padding:14px;margin-bottom:14px}
    .row{display:flex;gap:10px;flex-wrap:wrap}
    .row>*{flex:1 1 150px}
    label{display:block;font-size:12px;color:var(--muted);margin-bottom:6px}
    input,button{width:100%;padding:10px;border-radius:10px;border:1px solid #2a2a34;background:#121218;color:var(--fg)}
    button.primary{background:var(--accent);color:#001018;border:none;font-weight:700}
    button.good{background:var(--ok);color:#001108;border:none}
    button.bad{background:#2b1a1a;border:1px solid #3c1b1b;color:#ffb3b3}
    .kv{display:grid;grid-template-columns:1fr auto;gap:6px;font-variant-numeric:tabular-nums}
    .dot{width:8px;height:8px;border-radius:50%;display:inline-block;margin-right:8px;vertical-align:middle}
    .dot.ok{background:var(--ok)} .dot.bad{background:var(--bad)}
    .mono{font-family:ui-monospace,SFMono-Regular,Menlo,Consolas,monospace}
    .small{font-size:12px;color:var(--muted)}
  </style>
  <!-- mqtt.js from CDN -->
  <script src="https://unpkg.com/mqtt/dist/mqtt.min.js"></script>
</head>
<body>
  <header>
    <h1>M5 IMU+GPS Publisher</h1>
    <div class="ver">v0.2 • native roll/pitch</div>
  </header>

  <main>
    <!-- Status -->
    <div class="card">
      <div class="kv">
        <div><span id="mqtt-dot" class="dot bad"></span>MQTT</div><div id="mqtt-status">disconnected</div>
        <div><span id="sensor-dot" class="dot bad"></span>Sensors</div><div id="sensor-status">disabled</div>
        <div><span id="gps-dot" class="dot bad"></span>GPS</div><div id="gps-status">waiting</div>
      </div>
    </div>

    <!-- Controls -->
    <div class="card">
      <div class="row">
        <div>
          <label>Unit ID</label>
          <input id="unitId" placeholder="Eirik" />
        </div>
        <div>
          <label>Publish Rate (Hz)</label>
          <input id="pubHz" type="number" min="1" max="30" step="1" value="10" />
        </div>
      </div>
      <div class="row">
        <div>
          <label>Broker URL (WSS)</label>
          <input id="brokerUrl" class="mono" value="wss://afe7881f82fe42929e4a5370cddc7285.s1.eu.hivemq.cloud:8884/mqtt" />
        </div>
      </div>
      <div class="row">
        <div>
          <label>MQTT Username</label>
          <input id="mqttUser" value="wildsailor" />
        </div>
        <div>
          <label>MQTT Password</label>
          <input id="mqttPass" type="password" value="Sailorinthewild1" />
        </div>
      </div>
      <div class="row">
        <button id="enableSensors" class="primary">Enable Sensors</button>
        <button id="connectBtn" class="good">Connect MQTT</button>
        <button id="disconnectBtn" class="bad">Disconnect</button>
      </div>
      <div class="small">
        Publishes to <span class="mono">m5/&lt;UnitID&gt;/telemetry</span> and sets <span class="mono">m5/&lt;UnitID&gt;/status</span> to <em>online/offline</em>.
      </div>
    </div>

    <!-- Live data -->
    <div class="card">
      <div class="row">
        <div><label>Roll (deg, γ)</label><div id="roll" class="mono">--</div></div>
        <div><label>Pitch (deg, β)</label><div id="pitch" class="mono">--</div></div>
      </div>
      <div class="row">
        <div><label>Lat</label><div id="lat" class="mono">--</div></div>
        <div><label>Lon</label><div id="lon" class="mono">--</div></div>
      </div>
      <div class="small">Using iPhone’s native <span class="mono">deviceorientation</span>: pitch=β (X axis), roll=γ (Y axis). Alpha (yaw) is unused.</div>
    </div>

    <!-- Log -->
    <div class="card">
      <label>Last JSON</label>
      <pre id="lastJson" class="mono" style="white-space:pre-wrap;margin:0">—</pre>
    </div>
  </main>

<script type="module">
/*** DOM refs ***/
const $ = id => document.getElementById(id);
const mqttDot = $('mqtt-dot'), sensorDot = $('sensor-dot'), gpsDot = $('gps-dot');
const mqttStatus = $('mqtt-status'), sensorStatus = $('sensor-status'), gpsStatus = $('gps-status');
const rollEl=$('roll'), pitchEl=$('pitch'), lastJson=$('lastJson');
const unitIdIn=$('unitId'), brokerUrlIn=$('brokerUrl'), mqttUserIn=$('mqttUser'), mqttPassIn=$('mqttPass'), pubHzIn=$('pubHz');

/*** State ***/
let client=null, connected=false, seq=0;
let lat=null, lon=null, lastGpsTs=0;
let roll_deg=null, pitch_deg=null; // native iPhone angles

unitIdIn.value = localStorage.getItem('unitId') || 'Eirik';

function setDot(dot, ok){ dot.classList.toggle('ok', ok); dot.classList.toggle('bad', !ok); }
function setStatus(elm, txt){ elm.textContent = txt; }

/*** Sensors ***/
async function enableSensors(){
  try{
    // iOS permissions (need user gesture)
    if (typeof DeviceOrientationEvent!=='undefined' && typeof DeviceOrientationEvent.requestPermission==='function'){
      const resp = await DeviceOrientationEvent.requestPermission();
      if (resp!=='granted') throw new Error('Orientation permission denied');
    }
    startOrientation(); startGPS();
    setDot(sensorDot,true); setStatus(sensorStatus,'enabled');
  }catch(err){
    setDot(sensorDot,false); setStatus(sensorStatus,'error: '+err.message);
  }
}

// Use deviceorientation: beta (pitch), gamma (roll). Values are degrees.
function startOrientation(){
  window.addEventListener('deviceorientation', (e) => {
    // e.beta:  -180..180 (pitch, X axis)
    // e.gamma:  -90..90  (roll,  Y axis)
    // e.alpha:   0..360  (yaw,   Z axis) — not used
    // Note: These are in the device coordinate frame; if you need portrait/landscape compensation, add it here.
    pitch_deg = (e.beta  ?? 0);
    roll_deg  = (e.gamma ?? 0);
    rollEl.textContent  = isFinite(roll_deg)  ? roll_deg.toFixed(2)  : '--';
    pitchEl.textContent = isFinite(pitch_deg) ? pitch_deg.toFixed(2) : '--';
  }, { capture:false });
}

function startGPS(){
  if (!('geolocation' in navigator)){ setStatus(gpsStatus,'unavailable'); setDot(gpsDot,false); return; }
  navigator.geolocation.watchPosition(pos=>{
    lat=pos.coords.latitude; lon=pos.coords.longitude; lastGpsTs=Date.now();
    $('lat').textContent=lat.toFixed(6); $('lon').textContent=lon.toFixed(6);
    setStatus(gpsStatus,'ok'); setDot(gpsDot,true);
  }, err=>{ setStatus(gpsStatus,'err '+err.code); setDot(gpsDot,false); },
  {enableHighAccuracy:true, maximumAge:2000, timeout:10000});
}

/*** MQTT ***/
function topics(uid){ return { tele:`m5/${uid}/telemetry`, status:`m5/${uid}/status` }; }

function connectMQTT(){
  const unitId=(unitIdIn.value||'web').trim(); localStorage.setItem('unitId',unitId);
  const url=brokerUrlIn.value.trim(), username=mqttUserIn.value.trim(), password=mqttPassIn.value;
  const will={topic:topics(unitId).status, payload:'offline', qos:0, retain:true};
  const clientId=`iphone-${Math.random().toString(16).slice(2,10)}`;
  client = mqtt.connect(url,{clean:true, connectTimeout:10000, clientId, username, password, protocolVersion:4, will});
  client.on('connect',()=>{ connected=true; setDot(mqttDot,true); setStatus(mqttStatus,`connected (${clientId})`);
    client.publish(topics(unitId).status,'online',{retain:true}); });
  client.on('reconnect',()=>setStatus(mqttStatus,'reconnecting...'));
  client.on('close',()=>{ connected=false; setDot(mqttDot,false); setStatus(mqttStatus,'disconnected'); });
  client.on('error',err=>{ setDot(mqttDot,false); setStatus(mqttStatus,'error: '+err.message); });
}
function disconnectMQTT(){ if(client){ client.end(true); } connected=false; setDot(mqttDot,false); setStatus(mqttStatus,'disconnected'); }

/*** Publisher @ configurable Hz (default 10) ***/
let pubTimer=null;
function startPublishing(){
  if (pubTimer) clearInterval(pubTimer);
  const hz = Math.max(1, Math.min(30, parseInt(pubHzIn.value||'10',10)));
  const period = 1000/hz;
  pubTimer=setInterval(()=>{
    if(!connected) return;
    const unitId=(unitIdIn.value||'web').trim(), t=topics(unitId);

    const gps_ok = (Date.now()-lastGpsTs) < 3000;
    // If no orientation yet, send nulls (or replace with 0 if you prefer)
    const payload = gps_ok
      ? {unit_id:unitId, seq:seq++, roll_deg: finiteOrNull(roll_deg), pitch_deg: finiteOrNull(pitch_deg), lat, lon}
      : {unit_id:unitId, seq:seq++, roll_deg: finiteOrNull(roll_deg), pitch_deg: finiteOrNull(pitch_deg), lat:null, lon:null};

    const json = JSON.stringify(payload);
    lastJson.textContent = json;
    client.publish(t.tele, json);
  }, period);
}
const finiteOrNull = (v)=> Number.isFinite(v) ? +v.toFixed(2) : null;

/*** UI wiring ***/
$('enableSensors').addEventListener('click', enableSensors);
$('connectBtn').addEventListener('click', ()=>{ connectMQTT(); startPublishing(); });
$('disconnectBtn').addEventListener('click', ()=>{ disconnectMQTT(); if (pubTimer) clearInterval(pubTimer); });
</script>
</body>
</html>
